---
title: エクスポートとプリロード
sidebar_position: 5
---

## 読み込み順序

### ESMスクリプト

ESMスクリプトには明示的な読み込み順序がなく、特定の順序で読み込まれると想定すべきではありません。代わりに、モジュール間の依存関係を宣言するには、モジュールのインポートステートメントを使用する必要があります。

### クラシックスクリプト

一般的に、すべてのスクリプトはアプリケーションの開始時に読み込まれます。読み込み順序は、メインエディタメニューまたはシーン設定からアクセスできるプロジェクトの設定によって決まります。

![Loading Order](/img/user-manual/scripting/script-loading-order.jpg)

読み込み順序パネルには、`preload`としてマークされたすべてのクラシックスクリプトと、それらが読み込まれて実行される順序が表示されます。

![Loading Order List](/img/user-manual/scripting/loading-order-list.jpg)

個々のスクリプトをクリックしてドラッグし、順序を編集できます。

スクリプトが最初に読み込まれると、すぐに実行されます。つまり、スクリプトは最初に読み込まれた順序で実行されます。ただし、スクリプトの読み込み順序は、スクリプトコンポーネント内のスクリプトメソッドの実行順序に**影響しません**。たとえば、同じエンティティ上のスクリプトの`initialize`メソッドは、読み込み順序ではなく、エンティティにリストされている順序で呼び出されます。

## プリロード

デフォルトでは、PlayCanvasの他のアセットと同様に、スクリプトアセットは`preload`としてマークされています。これは、アプリケーションの開始前に読み込まれることを意味します。スクリプトでプリロードを無効にすると、通常の状況では読み込まれません。このようにして、プロジェクトにスクリプトを含めることができますが、`preload`のチェックを外すことで読み込みを防止できます。通常のAsset APIを使用して、プリロードされていないスクリプトの読み込みを動的にトリガーできます（[`AssetRegistry#load`](https://api.playcanvas.com/engine/classes/AssetRegistry.html#load)を参照）。

スクリプトレジストリの動的な変更を購読することができます。

```javascript
this.app.scripts.on('add', (name, scriptType) => {
    console.log('script', name, 'has been loaded');
});
```

## エクスポート

PlayCanvasプロジェクトを公開またはエクスポートする場合、スクリプトの処理方法は、クラシックスクリプトを使用しているか、ECMAScript Modules（ESM）を使用しているかによって異なります。

### クラシックスクリプト

すべてのプリロードされたクラシックスクリプトは、デフォルトで単一ファイルに連結されます。これにより、ネットワークリクエストの数が減り、ロード時間が短縮されます。この方法は、古いプロジェクトとの互換性を確保し、単純なコードベースに最適です。

### ESMスクリプト

ESMスクリプトを使用するプロジェクトは、最新のバンドルと最適化プロセスを経ます。プロジェクトにESMスクリプトが含まれている場合、エクスポートプロセスは自動的にESMビルドを生成します。

ESMビルドの主な機能：
 - **バンドルされた出力**
コードは、PlayCanvasエンジンを含めて（オプション）、最適化されたJavaScriptファイルのセットにバンドルされます。
 - **ツリーシェイキング** 使用されていないコードが削除され、バンドルサイズが縮小されます。
 - **コード分割** アプリケーションはより小さなチャンクに分割され、必要になった場合にのみ読み込まれます。これにより、重要なコードを優先することで、体感パフォーマンスが向上します。
 - **ミニファイ（オプション）** スクリプトのミニファイを有効にすると、コードも圧縮され、ダウンロードサイズがさらに縮小されます。
 - **連結オプション** スクリプトの連結を有効にすると、エクスポーターは使用パターンに基づいて、エンジンを含むアプリケーション全体を最も効率的な構造にバンドルします。

#### コード分割

コードの分割場所を細かく制御することはできませんが、それに影響を与えることができます。静的インポートではなく動的`import()`ステートメントを使用する場合、バンドラーはそのモジュールをオンデマンド読み込みの候補として扱います。これにより、メニュー、オプションツール、カットシーンなどの機能を実際に必要になるまで延期することができます。

#### ESMとクラシックスクリプトの混合

同じプロジェクト内でESMとクラシックスクリプトを自由に混合できます。ただし、それらは異なる方法で処理されます。

- ESMスクリプトはバンドルされ、最適化され、ツリーシェイキングとコード分割の恩恵を受けることができます。
 - クラシックスクリプトは個別のファイルとして含まれ、ESMバンドルの一部ではありません。

これは、最新の開発プラクティスを可能にしながら、後方互換性を確保します。

:::warning
クラシックスクリプト内で`import()`を使用してESMモジュールを読み込むことは避けてください。バンドルされたモジュールの最終パスはエクスポート中に変更される可能性があり、クラシックスクリプトはそれらを正しく解決できません。
:::
